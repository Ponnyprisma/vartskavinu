function addDateToList(a,b,c){$('div[data-content="'+a+'"]').find('.'+b).text(c)}function addMarkerToDB(a,b,c){markerData={marker_id:a,lat:b.lat(),lng:b.lng(),address:c},$.ajax({type:'POST',data:markerData,url:'/map/addmarker/',success:function(a){}})}function deleteMarkerFromDB(a){markerData={marker_id:a},$.ajax({type:'POST',data:markerData,url:'/map/deletemarker/',success:function(a){}})}function updateMarkerInDB(a,b,c){markerData={marker_id:a,lat:b.lat(),lng:b.lng(),address:c},$.ajax({type:'POST',data:markerData,url:'/map/updatemarker/',success:function(a){}})}function getAllMarkersFromDB(){$.ajax({type:'POST',url:'/map/getallmarkers/',dataType:'json',success:function(a){for(var b in a)this_marker_id=Number(a[b].marker_id),this_latlng=new google.maps.LatLng(a[b].lat,a[b].lng),this_address=a[b].address,this_arrival_date=a[b].arrival_date,this_departure_date=a[b].departure_date,addStaticMarker(this_latlng,this_address,this_marker_id,this_arrival_date,this_departure_date),addToPlacesList(this_address,this_marker_id),addDateToList(this_marker_id,'arrival_date',this_arrival_date),addDateToList(this_marker_id,'departure_date',this_departure_date);round_trip&&setRoundTrip()}})}function changeRoundTripInDB(){$.ajax({type:'POST',url:'/map/changeroundtrip/',success:function(a){}})}function getRoundTripFromDB(){$.ajax({type:'POST',url:'/map/getroundtrip/',dataType:'json',success:function(a){'1'===a.round_trip&&(round_trip=!0)}})}function setDateInDB(a,b,c){markerData={marker_id:a,type_of_trip:b,date:c},$.ajax({type:'POST',url:'/map/setdate/',data:markerData,success:function(a){}})}function addLocation(a){function b(b,c){if(c!==google.maps.GeocoderStatus.OK)return console.error(c),!1;if(b[2]){var d=b[2].formatted_address,e=addStaticMarker(a,d);addToPlacesList(d,e),addMarkerToDB(e,a,d)}else alert('Ingen address hittad!')}geocoder.geocode({location:a},b)}function updateLocation(a,b,c){function d(a,d){if(d!==google.maps.GeocoderStatus.OK)return console.error(d),!1;if(a[2]){var e=a[2].formatted_address;$('#'+c+'_address').text(e),updatePlaceList(c,e),updateMarkerInDB(c,b,e)}else alert('Ingen address hittad!')}geocoder.geocode({location:b},d);var e;for(i in markers)Number(c)===Number(i)&&(e=markers[i])}function removeLocationAndMarker(a){$('.place[data-target="'+a+'"]').fadeOut(200,function(){$(this).remove()}),markers[a].setMap(null),delete markers[a],updatePath(markers),updateMarkerTitles(markers)}function setMovableMarker(a){var b;movable_marker&&movable_marker.setMap(null),movable_marker=new google.maps.Marker({position:a,map:map,draggable:!0,icon:personMarker}),geocoder.geocode({location:a},function(a,c){if(c!==google.maps.GeocoderStatus.OK)return console.error(c),movable_marker.setMap(null),!1;if(a[2]){var d=a[2].formatted_address;b=addInfoWindow(movable_marker,createMovableMarkerBtn(d)),b.open(map,movable_marker)}else alert('Ingen address hittad!'),movable_marker.setMap(null)}),google.maps.event.addListener(movable_marker,'dragend',function(a){geocoder.geocode({location:a.latLng},function(a,c){if(c!==google.maps.GeocoderStatus.OK)return console.error(c),!1;if(a[2]){var d=a[2].formatted_address;b.setContent(createMovableMarkerBtn(d))}else alert('Ingen address hittad!')})})}function createMovableMarkerBtn(a){var b='';return b+='<p><strong>Hittad adress</strong><br />'+a+'</p>',b+='<a href="#" class="btn btn-primary btn-sm btn-block" id="place_marker">Placera markör</a>'}function addToPath(a,b){'undefined'!=typeof b&&(round_trip&&path_coordinates.pop(),path_coordinates.push({lat:a.lat(),lng:a.lng()}),round_trip&&path_coordinates.push({lat:markers[0].getPosition().lat(),lng:markers[0].getPosition().lng()}),path&&path.setMap(null),createPath(path_coordinates))}function updatePath(a){path_coordinates=[],bounds=new google.maps.LatLngBounds;for(i in a)latlng=new google.maps.LatLng(a[i].getPosition().lat(),a[i].getPosition().lng()),path_coordinates.push(latlng),bounds.extend(latlng);round_trip&&path_coordinates.push({lat:a[0].getPosition().lat(),lng:a[0].getPosition().lng()}),path&&path.setMap(null),createPath(path_coordinates)}function createPath(a){path=new google.maps.Polyline({path:a,geodesic:!0,strokeColor:'#ffcc00',strokeOpacity:.5,strokeWeight:10}),path.setMap(map)}function addToPlacesList(a,b){var c='';c+='<div class="col-xs-12 place" data-content="'+b+'">',c+='<h5 class="text-white">'+a+'</h5>',c+='<p class="text-white arrival_date_wrap"><i class="fa fa-plane fa-fw fa-rotate-90"></i><span class="arrival_date"></span></p>',c+='<p class="text-white departure_date_wrap"><i class="fa fa-plane fa-fw"></i><span class="departure_date"></span></p>',c+='</div>',0===b?($('#places-list-start').append(c),$('#places-list-end').append(c)):$('#places-list').append(c)}function updatePlaceList(a,b){$('div[data-content="'+a+'"] h5').text(b)}function findByForm(a){geocoder.geocode({address:a},function(a,b){if(b!==google.maps.GeocoderStatus.OK)return console.error(b),!1;var c=a[0].geometry.location;map.setCenter(c),setMovableMarker(c)})}function addStaticMarker(a,b,c,d,e){d='undefined'!=typeof d?d:'',e='undefined'!=typeof e?e:'';var f=new google.maps.Marker({position:a,map:map,icon:standardMarker,animation:google.maps.Animation.DROP,draggable:!0});markers.push(f),c='undefined'!=typeof c?c:markers.length-1,updateMarkerTitles(markers);var g=addInfoWindow(f,createStaticMarkerContent(f,c,b,d,e));return addToPath(a,c),bounds.extend(a),markers.length>1&&map.fitBounds(bounds),f.addListener('dragend',function(a){updatePath(markers),updateLocation(g,a.latLng,c)}),f.addListener('drag',function(a){path.setOptions({strokeOpacity:.2})}),c}function addInfoWindow(a,b,c,d){var e=new google.maps.InfoWindow({content:b});return a.addListener('click',function(){e.open(a.get('map'),a)}),e}function createStaticMarkerContent(a,b,c,d,e){var f='';return f+='<div class="static-marker-content">',f+='<h4 id="'+b+'_address">'+c+'</h4>',f+='<form class="form">',0===b&&(f+='<div class="form-group">',f+='<input type="text" name="departure_date" data-target="'+b+'" class="form-control datepicker minDate startdate" value="'+e+'">',f+='</div>',f+='<div class="form-group">',f+='<label><input type="checkbox" id="round-trip" value="1" ',round_trip&&(f+=' checked="checked"'),f+='> Rundresa</label>',f+='</div>',f+='<div class="form-group">',f+='<input type="text" name="arrival_date" data-target="'+b+'" class="form-control datepicker maxDate enddate',round_trip&&(f+=' visible'),f+='" id="roundtrip_arrival_date" value="'+d+'">',f+='</div>'),0!==b&&(f+='<div class="form-group">',f+='<input type="text" name="arrival_date" data-target="'+b+'" class="form-control datepicker minDate" value="'+d+'">',f+='<input type="text" name="departure_date" data-target="'+b+'" class="form-control datepicker minDate" value="'+e+'">',f+='<a href="#" class="delete-marker" data-target="'+b+'">Radera markör</a>',f+='</div>'),f+='</form>',f+='</div>'}function setRoundTrip(){var a=markers[0].getPosition();addToPath(a),round_trip=!0,$('input#roundtrip_arrival_date').slideDown(500,function(){$(this).addClass('visible')}),$('#places-list-end').slideDown(500,function(){$(this).addClass('visible')}),console.log('round trip set')}function setOneWayTrip(){round_trip=!1,updatePath(markers),$('input#roundtrip_arrival_date').slideUp(200,function(){$(this).removeClass('visible')}),$('#places-list-end').slideUp(200,function(){$(this).removeClass('visible')})}function updateMarkerTitles(a){var b=0;for(var c in a){var d=0===b?'Resan startar här':'Resmål nummer '+b;a[c].setTitle(d),b+=1}}var newMaxDate=null,newMinDate=new Date;$(document).ready(function(){$('[data-toggle="offcanvas"]').click(function(){$('.row-offcanvas').toggleClass('active')}),$('body').on('focus','.datepicker:not(.startdate)',function(){$(this).datepicker({minDate:newMinDate,maxDate:newMaxDate,dateFormat:'yy-mm-dd',onClose:function(a){var b=$(this).attr('data-target'),c=$(this).attr('name');addDateToList(b,c,a),setDateInDB(b,c,a),$(this).hasClass('minDate')?newMinDate=a:$(this).hasClass('maxDate')&&(newMaxDate=a,$('.datepicker.minDate').datepicker('option','maxDate',newMaxDate))}})}),$('body').on('focus','.datepicker.startdate',function(){$(this).datepicker({minDate:new Date,maxDate:newMaxDate,dateFormat:'yy-mm-dd',onClose:function(a){var b=$(this).attr('data-target'),c=$(this).attr('name');addDateToList(b,c,a),setDateInDB(b,c,a),newMinDate=''===a?new Date:a,$('.datepicker.minDate').not('.startdate').datepicker('option','minDate',newMinDate)}})})});var map,geocoder,path,path_coordinates=[],center_lat=59.317305,center_lng=18.034087,movable_marker,markers=[],round_trip=!1,bounds,standardMarker=new google.maps.MarkerImage('/px/marker_member-44x60-2x.png',null,null,null,new google.maps.Size(22,30)),personMarker=new google.maps.MarkerImage('/px/marker_person-44x60-2x.png',null,null,null,new google.maps.Size(22,30));getRoundTripFromDB(),$(document).ready(function(){getAllMarkersFromDB(),$('#gmap').ready(function(){var a=new google.maps.LatLng(center_lat,center_lng),b={styles:styles,zoom:6,center:a};map=new google.maps.Map(document.getElementById('gmap'),b),geocoder=new google.maps.Geocoder,bounds=new google.maps.LatLngBounds;for(var c in markers)latlng=new google.maps.LatLng(markers[c].lat,markers[c].lng),addLocation(latlng);google.maps.event.addListener(map,'rightclick',function(a){setMovableMarker(a.latLng)}),$(document).on('click','#place_marker',function(a){movable_marker&&movable_marker.setMap(null),latlng=movable_marker.getPosition(),addLocation(latlng)}),$('#geocoding_form').on('submit',function(a){a.preventDefault();var b=$('#geocoding_form_address').val();findByForm(b)}),$(document).on('click','.delete-marker',function(a){a.preventDefault();var b=$(this).attr('data-target');confirm('Radera resmål?')&&(removeLocationAndMarker(b),deleteMarkerFromDB(b))}),$(document).on('change','#round-trip',function(a){$(this).prop('checked')===!0?setRoundTrip():setOneWayTrip(),changeRoundTripInDB()})})});var styles=[{featureType:'water',elementType:'geometry',stylers:[{color:'#352a40'}]},{featureType:'landscape',elementType:'geometry',stylers:[{color:'#352a40'},{lightness:20}]},{featureType:'road',elementType:'geometry',stylers:[{color:'#352a40'},{lightness:37}]},{featureType:'poi',elementType:'geometry',stylers:[{color:'#352a40'},{lightness:25}]},{featureType:'transit',elementType:'geometry',stylers:[{color:'#352a40'},{lightness:15}]},{elementType:'labels.text.stroke',stylers:[{visibility:'on'},{color:'#3e606f'},{weight:2},{gamma:.84}]},{elementType:'labels.text.fill',stylers:[{color:'#ffffff'}]},{featureType:'administrative',elementType:'geometry',stylers:[{weight:.6},{color:'#ffcc00'}]},{elementType:'labels.icon',stylers:[{visibility:'off'}]},{featureType:'poi.park',elementType:'geometry',stylers:[{color:'#352a40'},{lightness:25}]}],styles_=[{featureType:'landscape.natural',elementType:'geometry.fill',stylers:[{visibility:'on'},{color:'#FFCC00'}]},{featureType:'poi',elementType:'geometry.fill',stylers:[{visibility:'on'},{hue:'#352A40'},{color:'#ffb700'}]},{featureType:'road',elementType:'geometry',stylers:[{lightness:100},{visibility:'simplified'}]},{featureType:'road',elementType:'labels',stylers:[{visibility:'off'}]},{featureType:'transit.line',elementType:'geometry',stylers:[{visibility:'on'},{lightness:700}]},{featureType:'water',elementType:'all',stylers:[{color:'#352A40'}]}];